@model CustomerMasterModel
@using System.Text.Json

@{
    ViewBag.Title = "Dashboard";
}

<!-- Meta & Fonts -->
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="~/css/dashboard.css" />

<style>
    /* Header Layout */
    .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 0 10px;
    }

    .header-left,
    .header-center,
    .header-right {
        flex: 1;
        display: flex;
        align-items: center;
    }

    .header-left {
        justify-content: flex-start;
    }

    .header-center {
        justify-content: center;
    }

    .header-right {
        justify-content: flex-end;
        font-size: 15px;
        color: #444;
        font-weight: 500;
        font-family: 'Roboto', sans-serif;
    }

    .header-logo {
        height: 60px;
        width: auto;
        margin-right: 10px;
    }

    /* Theme Variables */
    :root {
        --bg-light: #f4f7fa;
        --card-light: #ffffff;
        --text-light: #333;
    }

    body {
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 20px;
        background-color: var(--bg-light);
        color: var(--text-light);
        transition: background-color 0.3s, color 0.3s;
    }

    h2 {
        margin: 0;
        font-size: 32px;
        font-weight: 600;
        color: #222;
    }

    .dashboard-container {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        padding: 1rem;
        max-width: 100%;
    }

    .chart-row {
        display: flex;
        gap: 1rem;
        justify-content: space-between;
        flex-wrap: wrap;
    }

    .chart-card {
        flex: 1 1 calc(33.333% - 1rem);
        min-width: 250px;
        background: var(--card-light);
        padding: 1rem;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        transition: transform 0.2s ease;
    }

<<<<<<< HEAD
        .chart-card:hover {
            transform: scale(1.01);
        }

=======
    body.dark-mode .chart-card {
        background-color: var(--card-dark);
    }

    .chart-card:hover {
        transform: scale(1.005);
    }
 */
>>>>>>> 02376c2c66861debd4693b531254b3934d419792
    canvas {
        width: 100% !important;
        height: 300px !important;
    }

    .spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border: 4px solid #ccc;
        border-top-color: #333;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        z-index: 10;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    footer {
        text-align: center;
        padding: 20px;
        font-size: 14px;
        color: #777;
    }
</style>

<!-- Header Section -->
<div class="header-container">
    <div class="header-left">
        <img src="~/images/syrmasgs.png" alt="Logo" class="header-logo" />
    </div>
    <div class="header-center">
        <h2>📊 Honeywell Dashboard</h2>
    </div>
    <div class="header-right">
        <span id="liveClock"></span>
    </div>

</div>

<!-- Dashboard Section -->
<div class="dashboard-container">
    <!-- Row 1 -->
    <div class="chart-row">
        <div class="chart-card">
            <div class="spinner" id="spinnerPie"></div>
            <canvas id="piechart"></canvas>
        </div>
        <div class="chart-card">
            <div class="spinner" id="spinnerLabLos"></div>
            <canvas id="labLosChart"></canvas>
        </div>
        <div class="chart-card">
            <div class="spinner" id="spinnerLineUtil"></div>
            <canvas id="lineUtilChart"></canvas>
        </div>
    </div>

    <!-- Row 2 -->
    <div class="chart-row">
        <div class="chart-card">
            <div class="spinner" id="spinnerYield"></div>
            <canvas id="yieldChart"></canvas>
        </div>
        <div class="chart-card">
            <div class="spinner" id="spinnerStage"></div>
            <canvas id="lineChart1"></canvas>
        </div>
    </div>
</div>

<!-- Footer -->
<footer>
    &copy; @DateTime.Now.Year - Manufacturing Analytics Dashboard
</footer>

<!-- jQuery & Chart.js -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>



<script>
    // Plugin to draw text in the center of the doughnut chart
    const centerTextPlugin = {
        id: 'centerText',
        beforeDraw(chart) {
            const { width, height, ctx } = chart;
            ctx.restore();
            const fontSize = (height / 150).toFixed(2);
            ctx.font = `${fontSize}em sans-serif`;
            ctx.textBaseline = "middle";

            const text = chart.config.options.plugins.centerText?.text || '';
            const textX = Math.round((width - ctx.measureText(text).width) / 2);
            const textY = height / 2;

            ctx.fillText(text, textX, textY);
            ctx.save();
        }
    };
</script>

<script>
    function updateClock() {
        const now = new Date();

<<<<<<< HEAD
        const options = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        };
=======
        if (!fgname || !type || fgname.trim() === "" || type.trim() === "") {
            alert("Please select both FG Name and Type before viewing the chart.");
            window.location.href = "/DashBoardMaster/ProdcutionMaster"; 
            return;
        }

        const toggle = document.getElementById('darkModeToggle');
        const currentMode = localStorage.getItem('theme');
>>>>>>> 02376c2c66861debd4693b531254b3934d419792

        const formatted = now.toLocaleString('en-US', options);
        document.getElementById('liveClock').innerText = formatted;
    }

    // Run clock immediately, then every second
    updateClock();
    setInterval(updateClock, 1000);
</script>

<script>
    const fgname = @Html.Raw(JsonSerializer.Serialize(Model.FGName));
    const type = @Html.Raw(JsonSerializer.Serialize(Model.Type));

<<<<<<< HEAD
    const generateColor = () => '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');

    const loadAllCharts = () => {
=======


>>>>>>> 02376c2c66861debd4693b531254b3934d419792
        // Show all spinners initially
        $('#spinnerLabLos, #spinnerLineUtil, #spinnerYield, #spinnerStage, #spinnerPie').show();

        // === 1. LAB LOS CHART ===
        $.get('/DashBoardMaster/GetlablosData', { Fgname: fgname, Type: type }, function (data) {
            $('#spinnerLabLos').hide();
            if (!data || data.length === 0) return;
<<<<<<< HEAD
            const value = Math.round(data[0].labr_loss ?? 0);
            const remaining = 100 - value;
=======

            const labels = data.map(d => d.hourIntervel);
            const values = data.map(d => d.labr_loss);
            const bg = labels.map(() => generateColor());
            console.log(data);
>>>>>>> 02376c2c66861debd4693b531254b3934d419792
            const ctx = document.getElementById('labLosChart').getContext('2d');
            if (window.labLosChartInstance) window.labLosChartInstance.destroy();
            window.labLosChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
<<<<<<< HEAD
                    labels: ['Loss', 'Remaining'],
=======
                   
                    labels,
>>>>>>> 02376c2c66861debd4693b531254b3934d419792
                    datasets: [{
                        data: [value, remaining],
                        backgroundColor: ['#e74a3b', '#e0e0e0'],
                        borderWidth: 1,
                        offset: 10,
                        borderRadius: 20
                    }]
                },
                options: {
<<<<<<< HEAD
                    cutout: '50%',
=======
                    responsive: true,
>>>>>>> 02376c2c66861debd4693b531254b3934d419792
                    plugins: {
                        title: { display: true, text: 'Labor Loss' },
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: context => `${context.label}: ${context.raw.toFixed(2)}%`
                            }
                        },
                        centerText: { text: `${value}%` }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                },
                plugins: [centerTextPlugin]
            });
        });

        // === 2. LINE UTILIZATION CHART ===
        $.get('/DashBoardMaster/GetlineutilData', { Fgname: fgname, Type: type }, function (data) {
            $('#spinnerLineUtil').hide();
            if (!data || data.length === 0) return;
            const value = Math.round(data[0].line_util ?? 0);
            const remaining = 100 - value;
            const ctx = document.getElementById('lineUtilChart').getContext('2d');
            if (window.lineUtilChartInstance) window.lineUtilChartInstance.destroy();
            window.lineUtilChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Utilized', 'Remaining'],
                    datasets: [{
                        data: [value, remaining],
                        backgroundColor: ['#1cc88a', '#e0e0e0'],
                        borderWidth: 1,
                        offset: 10,
                        borderRadius: 20
                    }]
                },
                options: {
<<<<<<< HEAD
                    cutout: '50%',
=======
                    responsive: true,
>>>>>>> 02376c2c66861debd4693b531254b3934d419792
                    plugins: {
                        title: { display: true, text: 'Line Utilization' },
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: context => `${context.label}: ${context.raw.toFixed(2)}%`
                            }
                        },
                        centerText: { text: `${value}%` }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                },
                plugins: [centerTextPlugin]
            });
        });

        // === 3. YIELD CHART ===
        $.get('/DashBoardMaster/GetyieldData', { Fgname: fgname, Type: type }, function (data) {
            $('#spinnerYield').hide();
            const filtered = data.filter(d => d.yield != null && d.stage != null);
            if (filtered.length === 0) return;
            const labels = filtered.map(d => d.stage);
            const values = filtered.map(d => d.yield);
            const bg = labels.map(() => generateColor());
            const ctx = document.getElementById('yieldChart').getContext('2d');
            if (window.yieldChartInstance) window.yieldChartInstance.destroy();
            window.yieldChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Yield (%)',
                        data: values,
                        backgroundColor: bg
                    }]
                },
                options: {
<<<<<<< HEAD
=======
                    responsive: true,
>>>>>>> 02376c2c66861debd4693b531254b3934d419792
                    plugins: {
                        legend: {
                            display: false  // hides legend completely
                        },
                        title: { display: true, text: 'Yield by Stage' },
                        tooltip: {
                            callbacks: {
                                label: context => `${context.label}: ${context.raw.toFixed(2)}%`
                            }
                        },
                        datalabels: {
                            anchor: 'end',       // Anchored at end of bar
                            align: 'start',      // Aligned inside the bar at the start
                            offset: -15,         // Move a bit inward
                            color: '#000',       // White text for dark bars
                            font: { weight: 'bold' },
                            formatter: value => value.toFixed(0) + '%'
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Stage' } },
                        y: { beginAtZero: true, title: { display: true, text: 'Yield (%)' } }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                },
                plugins: [ChartDataLabels]
            });
        });

        // === 4. STAGE OUTPUT ===
        $.get('/DashBoardMaster/GetChartData', { Fgname: fgname, Type: type }, function (data) {
            $('#spinnerStage').hide();
            if (!data) return;

            // Helper to extract start hour from interval (e.g. "08-09" -> 8)
            function getStartHour(intervalStr) {
                const [start, end] = intervalStr.split('-');
                return parseInt(start);
            }

            // Sort data chronologically based on start hour
            const sortedData = data.slice().sort((a, b) => {
                return getStartHour(a.hourIntervel) - getStartHour(b.hourIntervel);
            });

            // Extract labels and values
            const labels = sortedData.map(d => d.hourIntervel);
            const targets = sortedData.map(d => d.target || 0);
            const actuals = sortedData.map(d => d.logCount || 0);

            // Draw chart
            const ctx = document.getElementById('lineChart1').getContext('2d');
            if (window.lineChartInstance) window.lineChartInstance.destroy();

            window.lineChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels, // Use actual hour intervals like "08-09"
                    datasets: [
                        {
                            label: 'Plan',
                            data: targets,
                            backgroundColor: generateColor()
                        },
                        {
                            label: 'Actual',
                            data: actuals,
                            backgroundColor: generateColor()
                        }
                    ]
                },
                options: {
<<<<<<< HEAD
=======
                    responsive: true,
>>>>>>> 02376c2c66861debd4693b531254b3934d419792
                    plugins: {
                        title: {
                            display: true,
                            text: 'Plan vs Actual by Hour Interval'
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            offset: -8,
                            color: '#000',
                            font: { weight: 'bold' },
                            formatter: value => value.toFixed(0)
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Hour Interval'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                },
                plugins: [ChartDataLabels]
            });
        });




        // === 5. PIE CHART (OEE) ===
        $.get('/DashBoardMaster/GetChartDataoee', { Fgname: fgname, Type: type }, function (data) {
            $('#spinnerPie').hide();
            if (!data || data.length === 0) return;
            const labels = data.map(d => d.label);
            const values = data.map(d => d.value);
            const bg = labels.map(() => generateColor());
            const oeeValue = (values[0] / 100) * (values[1] / 100) * (values[2] / 100);
            const oeePercentage = (oeeValue * 100).toFixed(0);
            const ctx = document.getElementById('piechart').getContext('2d');
            if (window.oeeChartInstance) window.oeeChartInstance.destroy();
            window.oeeChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        backgroundColor: bg,
                        borderWidth: 1,
                        offset: 10,
                        borderRadius: 20
                    }]
                },
                options: {
                    cutout: '50%',
                    plugins: {
                        title: { display: true, text: 'OEE Breakdown' },
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: context => `${context.label}: ${context.raw.toFixed(2)}%`
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            formatter: value => value.toFixed(0) + '%',
                            font: { weight: 'bold', size: 14 }
                        },
                        centerText: { text: `${oeePercentage}%` }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                },
                plugins: [centerTextPlugin, ChartDataLabels]
            });
        });
    };

    // Initial load
    $(document).ready(function () {
        Chart.register(ChartDataLabels);
        loadAllCharts();

        // Auto-refresh every 10 seconds (10,000 ms)
        setInterval(loadAllCharts, 100000);
    });
</script>

