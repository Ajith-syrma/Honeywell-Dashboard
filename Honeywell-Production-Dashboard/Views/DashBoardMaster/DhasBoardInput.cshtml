
@model CustomerMasterModel
@using System.Text.Json
@{
    ViewBag.Title = "Dashboard";
}

<!-- Meta & Fonts -->
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="~/css/dashboard.css" />

<style>
    /* Header Layout */
    .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 0 10px;
    }

    .header-left,
    .header-center,
    .header-right {
        flex: 1;
        display: flex;
        align-items: center;
    }

    .header-left {
        justify-content: flex-start;
    }

    .header-center {
        justify-content: center;
    }

    .header-right {
        justify-content: flex-end;
        font-size: 15px;
        color: #444;
        font-weight: 500;
        font-family: 'Roboto', sans-serif;
    }

    .header-logo {
        height: 60px;
        width: auto;
        margin-right: 10px;
    }

    /* Theme Variables */
    :root {
        --bg-light: #f4f7fa;
        --card-light: #ffffff;
        --text-light: #333;
    }

/*     body {
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 20px;
        background-color: var(--bg-light);
        color: var(--text-light);
        transition: background-color 0.3s, color 0.3s;
    }
 */
    body {
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 0; /* Remove global padding */
        background-color: var(--bg-light);
        color: var(--text-light);
        transition: background-color 0.3s, color 0.3s;
    }

    .dashboard-container {
        padding: 20px; /* Apply padding only where needed */
    }

    h2 {
        margin: 0;
        font-size: 32px;
        font-weight: 600;
        color: #222;
    }

    .dashboard-container {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        padding: 1rem;
        max-width: 100%;
    }

    .chart-row {
        display: flex;
        gap: 1rem;
        justify-content: space-between;
        flex-wrap: wrap;
    } 



    .chart-card {
        flex: 1 1 calc(33.333% - 1rem);
        min-width: 480px;
        background: var(--card-light);
       /*  background-color: #003b46; */
        padding: 1rem;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        transition: transform 0.2s ease;
    }




    .chart-card:hover {
        transform: scale(1.01);
    }

    body.dark-mode .chart-card {
        background-color: var(--card-dark);
    }

    .chart-card:hover {
        transform: scale(1.005);
    }
 
    canvas {
        width: 100% !important;
        height: 300px !important;
    }

    .spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border: 4px solid #ccc;
        border-top-color: #333;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        z-index: 10;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    footer {
        text-align: center;
        padding: 20px;
        font-size: 14px;
        color: #777;
    }
</style>

<!-- Header Section -->
@* <div class="header-container">
    <div class="header-left">
        <img src="~/images/syrmasgs.png" alt="Logo" class="header-logo" />
    </div>
    <div class="header-center">
        <h2>📊 Honeywell Dashboard</h2>
    </div>
    <div class="header-right">
        <span id="liveClock"></span>
    </div>

</div> *@

<!-- Dashboard Section -->
<div class="dashboard-container">
    <!-- Row 1 -->
    <div class="chart-row" style="display:none">
        <div class="chart-card">
            <div class="spinner" id="spinnerPie"></div>
            <canvas id="piechart"></canvas>
        </div>
        <div class="chart-card">
            <div class="spinner" id="spinnerLabLos"></div>
            <canvas id="labLosChart"></canvas>
        </div>
        <div class="chart-card">
            <div class="spinner" id="spinnerLineUtil"></div>
            <canvas id="lineUtilChart"></canvas>
        </div>
    </div>

    <!-- Row 2 -->
    <div class="chart-row">
        <div class="chart-card">
            <div class="spinner" id="spinnerYield"></div>
            <canvas id="yieldChart"></canvas>
        </div>
        <div class="chart-card">
            <div class="spinner" id="spinnerStage"></div>
            <canvas id="lineChart1"></canvas>
        </div>
    </div>
</div>

<!-- Footer -->
<footer>
    &copy; @DateTime.Now.Year - Manufacturing Analytics Dashboard by Syrma SGS-Tester Development
</footer>

<!-- jQuery & Chart.js -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>



<script>
    debugger;
     const customer = @Html.Raw(JsonSerializer.Serialize(Model.Customer));
      const fgname = @Html.Raw(JsonSerializer.Serialize(Model.FGName));
    const type = @Html.Raw(JsonSerializer.Serialize(Model.Type));
    // Plugin to draw text in the center of the doughnut chart
    const centerTextPlugin = {
        id: 'centerText',
        beforeDraw(chart) {
            const { width, height, ctx } = chart;
            ctx.restore();
            const fontSize = (height / 150).toFixed(2);
            ctx.font = `${fontSize}em sans-serif`;
            ctx.textBaseline = "middle";

            const text = chart.config.options.plugins.centerText?.text || '';
            const textX = Math.round((width - ctx.measureText(text).width) / 2);
            const textY = height / 2;

            ctx.fillText(text, textX, textY);
            ctx.save();
        }
    };
</script>

<script>
    function updateClock() {
        const now = new Date();

        const options = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        };

        if (!fgname || !type || fgname.trim() === "" || type.trim() === "") {
            alert("Please select both FG Name and Type before viewing the chart.");
            window.location.href = "/DashBoardMaster/ProdcutionMaster"; 
            return;
        }

        const toggle = document.getElementById('darkModeToggle');
        const currentMode = localStorage.getItem('theme');


        const formatted = now.toLocaleString('en-US', options);
        document.getElementById('liveClock').innerText = formatted;
    }

    // Run clock immediately, then every second
    updateClock();
    setInterval(updateClock, 50000);
</script>

<script>

    const colorSet = {
        plan: '#3498db',           // Blue for Plan
        actual: '#2ecc71',         // Green for Actual
        yield: '#f39c12',          // Orange for Yield
        pie: ['#FF6B6B', '#4ECDC4', '#1A535C']


    };

    const fixedBarColors = [
        '#3498db', '#2ecc71', '#f1c40f',
        '#9b59b6', '#1abc9c', '#e67e22', '#e74c3c'
    ];
 
  
     // const fgname="ECH3ELR00001";
      // const type ="";


    const generateColor = () => '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');

    const loadAllCharts = () => {


        // Show all spinners initially
        $('#spinnerLabLos, #spinnerLineUtil, #spinnerYield, #spinnerStage, #spinnerPie').show();

        // === 1. LAB LOS CHART ===
        $.get('/DashBoardMaster/GetlablosData', { Fgname: fgname, Type: type }, function (data) {
            $('#spinnerLabLos').hide();
            if (!data || data.length === 0) return;

            const value = Math.round(data[0].labr_loss ?? 0);
            const remaining = 100 - value;


            const labels = data.map(d => d.hourIntervel);
            const values = data.map(d => d.labr_loss);
            const bg = labels.map(() => generateColor());
            console.log(data);

            const ctx = document.getElementById('labLosChart').getContext('2d');
            if (window.labLosChartInstance) window.labLosChartInstance.destroy();
            window.labLosChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {

                    labels: ['Labour Loss', 'Labour Utilization'],
                    datasets: [{
                        data: [value, remaining],
                        backgroundColor: ['#e74a3b', '#e0e0e0'],
                        borderWidth: 1,
                        offset: 10,
                        borderRadius: 20
                    }]
                },
                options: {

                    cutout: '50%',

                    responsive: true,

                    plugins: {
                        title: { display: true, text: 'Labour Loss', font: { weight: 'bold', size: 16 } },
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: context => `${context.label}: ${context.raw.toFixed(2)}%`
                            }
                        },
                        centerText: { text: `${value}%` }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                },
                plugins: [centerTextPlugin]
            });
        });

        // === 2. LINE UTILIZATION CHART ===
        $.get('/DashBoardMaster/GetlineutilData', { Fgname: fgname, Type: type }, function (data) {
            $('#spinnerLineUtil').hide();
            if (!data || data.length === 0) return;
            const value = Math.round(data[0].line_util ?? 0);
            const remaining = 100 - value;
            const ctx = document.getElementById('lineUtilChart').getContext('2d');
            if (window.lineUtilChartInstance) window.lineUtilChartInstance.destroy();
            window.lineUtilChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Utilized', 'Un-Utilized'],
                    datasets: [{
                        data: [value, remaining],
                        backgroundColor: ['#1cc88a', '#e0e0e0'],
                        borderWidth: 1,
                        offset: 10,
                        borderRadius: 20
                    }]
                },
                options: {

                    cutout: '50%',

                    responsive: true,

                    plugins: {
                        title: { display: true, text: 'Line Utilization', font: { weight: 'bold', size: 16 } },
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: context => `${context.label}: ${context.raw.toFixed(2)}%`
                            }
                        },
                        centerText: { text: `${value}%` }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                },
                plugins: [centerTextPlugin]
            });
        });


        // === 3. YIELD CHART ===
        // $.get('/DashBoardMaster/GetyieldData', { Fgname: fgname, Type: type }, function (data) {
        //     $('#spinnerYield').hide();
        //     if (!data || data.length === 0) return;

        //     // Define the fixed stage labels in correct order
        //   //  const defaultStages = ["FCT-1", "FCT-2", "FCT-3", "RF-1", "RF-2", "RTC", "VOLT"];

        //     // Create a mapping from stage name to yield value
        //     const yieldMap = {};
        //     data.forEach(d => {
        //         const stageName = d.stage?.trim(); // Clean up whitespace
        //         if (stageName && d.yield != null) {
        //             yieldMap[stageName] = parseFloat(d.yield);
        //         }
        //     });

        //     // Build values in the correct stage order
        //     //const labels = defaultStages;
        //    // const values = defaultStages.map(stage => yieldMap[stage] ?? 0);  // Use 0 if not found
        //    // const bg = labels.map((_, i) => fixedBarColors[i % fixedBarColors.length]);
        //    const bg = values.map(value => value >= 90 ? '#2ecc71' : '#e74c3c'); // green or red



        //     const ctx = document.getElementById('yieldChart').getContext('2d');
        //     if (window.yieldChartInstance) window.yieldChartInstance.destroy();

        //     window.yieldChartInstance = new Chart(ctx, {
        //         type: 'bar',
        //         data: {
        //             labels: labels,
        //             datasets: [{
        //                 label: 'Yield (%)',
        //                 data: values,
        //                 backgroundColor: bg
        //             }]
        //         },
        //         options: {
        //             responsive: true,
        //             plugins: {
        //                 legend: {
        //                     display: false
        //                 },
        //                 title: {
        //                     display: true,
        //                     text: 'Yield by Stage',
        //                     font: {
        //                         weight: 'bold', size: 16
        //                     }
        //                 },
        //                 tooltip: {
        //                     callbacks: {
        //                         label: context => `${context.label}: ${context.raw.toFixed(2)}%`
        //                     }
        //                 },
        //                 datalabels: {
        //                     anchor: 'end',
        //                     align: 'start',
        //                     offset: -15,
        //                     color: '#000',
        //                     font: { weight: 'bold' },
        //                     formatter: value => value.toFixed(0) + '%'
        //                 }
        //             },
        //             scales: {
        //                 x: { title: { display: true, text: 'Stage' } },
        //                 y: {
        //                     beginAtZero: true,
        //                     title: { display: true, text: 'Yield (%)' }
        //                 }
        //             },
        //             maintainAspectRatio: false
        //         },
        //         plugins: [ChartDataLabels]
        //     });
        // });

     $.get('/DashBoardMaster/GetyieldData', { Fgname: fgname, Type: type }, function (data) {
        $('#spinnerYield').hide();
        if (!data || data.length === 0) return;

        // Extract labels and values dynamically from API data
        const labels = data.map(d => d.stage?.trim());
        const values = data.map(d => parseFloat(d.yield ?? 0));

        // Set color dynamically based on yield value
        const bg = values.map(value => value >= 90 ? '#2ecc71' : '#e74c3c');

        // Create or update the chart
        const ctx = document.getElementById('yieldChart').getContext('2d');
        if (window.yieldChartInstance) window.yieldChartInstance.destroy();

        window.yieldChartInstance = new Chart(ctx, {
             type: 'bar', // ← changed to line chart
            data: {
                labels: labels,
                datasets: [{
                    label: 'Yield (%)',
                    data: values,
                    backgroundColor: bg,
                    borderColor: '#3498db',
                    fill: false,
                    tension: 0.3,
                    borderWidth: 2,
                    pointRadius: 5,
                    pointBackgroundColor: bg
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Yield by Stage',
                        font: { weight: 'bold', size: 16 }
                    },
                    tooltip: {
                        callbacks: {
                            label: context => `${context.label}: ${context.raw.toFixed(2)}%`
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        offset: 5,
                        color: '#000',
                        font: { weight: 'bold' },
                        formatter: value => value.toFixed(1) + '%'
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Stage' } },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Yield (%)' },
                        max: 100
                    }
                },
                maintainAspectRatio: false
            },
            plugins: [ChartDataLabels]
        });
    });

        // === 4. STAGE OUTPUT ===
        $.get('/DashBoardMaster/GetChartData', { Fgname: fgname, Type: type }, function (data) {
            $('#spinnerStage').hide();
            if (!data) return;

            const totalIntervals = 8;
            const labels = Array.from({ length: totalIntervals }, (_, i) => (i + 1).toString());

            // Create a map from the incoming data (assumes each item has label or hour info)
            const dataMap = {};
            data.forEach((item, idx) => {
                // If hourIntervel is not used, fallback to index
                const label = (idx + 1).toString();  // Use actual logic if label is present in data
                dataMap[label] = item;
            });

            // Build targets and actuals using fixed labels
            const targets = [];
            const actuals = [];

            labels.forEach(label => {
                const item = dataMap[label];

                // Apply default logic
                let defaultTarget;
                if (label === "3") {
                    defaultTarget = 10;
                } else if (label === "5") {
                    defaultTarget = 6;
                } else {
                    defaultTarget = 12;
                }

                // Use target from data if exists, otherwise fallback to default
                targets.push(item?.target ?? defaultTarget);
                actuals.push(item?.logCount ?? 0);
            });

            // Draw chart
            const ctx = document.getElementById('lineChart1').getContext('2d');
            if (window.lineChartInstance) window.lineChartInstance.destroy();

            window.lineChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Plan',
                            data: targets,
                            //backgroundColor: generateColor()
                            backgroundColor: colorSet.plan  // for Plan

                        },
                        {
                            label: 'Actual',
                            data: actuals,
                            //backgroundColor: generateColor()
                            backgroundColor: colorSet.actual // for Actual
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Hourly output Plan vs Actual ',
                            font: {
                                weight: 'bold', size: 16
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            offset: -8,
                            color: '#000',
                            font: { weight: 'bold' },
                            formatter: value => value.toFixed(0)
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Intervals'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        }
                    },
                    maintainAspectRatio: false
                },
                plugins: [ChartDataLabels]
            });
        });








        // === 5. PIE CHART (OEE) ===
        $.get('/DashBoardMaster/GetChartDataoee', { Fgname: fgname, Type: type }, function (data) {
            $('#spinnerPie').hide();
            if (!data || data.length === 0) return;
            const labels = data.map(d => d.label);
            const values = data.map(d => d.value);
            //const bg = labels.map(() => generateColor());
            const bg = colorSet.pie;

            const oeeValue = (values[0] / 100) * (values[1] / 100) * (values[2] / 100);
            const oeePercentage = (oeeValue * 100).toFixed(0);
            const ctx = document.getElementById('piechart').getContext('2d');
            if (window.oeeChartInstance) window.oeeChartInstance.destroy();
            window.oeeChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        backgroundColor: bg,
                        borderWidth: 1,
                        offset: 10,
                        borderRadius: 20
                    }]
                },
                options: {
                    cutout: '50%',
                    plugins: {
                        title: { display: true, text: 'OEE Breakdown', font: { weight: 'bold', size: 16 } },
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: context => `${context.label}: ${context.raw.toFixed(2)}%`
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            formatter: value => value.toFixed(0) + '%',
                            font: { weight: 'bold', size: 14 }
                        },
                        centerText: { text: `${oeePercentage}%` }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                },
                plugins: [centerTextPlugin, ChartDataLabels]
            });
        });
    };

    // Initial load
    $(document).ready(function () {
        Chart.register(ChartDataLabels);
        loadAllCharts();

        // Auto-refresh every 10 seconds (10,000 ms)
        setInterval(loadAllCharts, 100000);
    });
</script>

